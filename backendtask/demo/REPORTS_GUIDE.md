# Руководство по системе отчетов

## Обзор

Система отчетов предоставляет возможность генерации детальных отчетов о тратах пользователей интернет-магазина. Отчеты включают информацию о:

- Пользователях и их общих тратах
- Заказах пользователей и их суммах
- Расчете общих сумм

## Функциональность

### 1. Отчет о тратах всех пользователей
- **Доступ**: Только для администраторов
- **Содержание**: Полная информация о тратах всех пользователей системы (включая пользователей без заказов)
- **Форматы**: JSON, PDF

### 2. Отчет о тратах конкретного пользователя
- **Доступ**: Администраторы или сам пользователь
- **Содержание**: Детальная информация о тратах указанного пользователя
- **Форматы**: JSON, PDF

### 3. Отчет топ-10 самых продаваемых товаров
- **Доступ**: Только для администраторов
- **Содержание**: Список топ-10 товаров, отсортированных по количеству продаж
- **Форматы**: JSON, PDF

## API Эндпоинты

### JSON Отчеты

#### GET /api/reports/spending
Получение отчета о тратах всех пользователей в формате JSON.

**Требования:**
- Авторизация: Bearer Token
- Роль: ADMIN

**Пример ответа:**
```json
{
  "reportDate": "2024-01-15T10:30:00",
  "userReports": [
    {
      "username": "john_doe",
      "userId": 1,
      "totalSpent": 1299.98,
      "orders": [
        {
          "orderId": 1,
          "orderStatus": "DELIVERED",
          "totalAmount": 999.99
        },
        {
          "orderId": 2,
          "orderStatus": "PENDING",
          "totalAmount": 299.99
        }
      ]
    },
    {
      "username": "jane_smith",
      "userId": 2,
      "totalSpent": 0,
      "orders": []
    }
  ],
  "grandTotal": 1299.98
}
```

#### GET /api/reports/spending/user/{userId}
Получение отчета о тратах конкретного пользователя в формате JSON.

**Параметры:**
- `userId` - ID пользователя

**Требования:**
- Авторизация: Bearer Token
- Роль: ADMIN или собственный userId

### PDF Отчеты

#### GET /api/reports/spending/pdf
Скачивание отчета о тратах всех пользователей в формате PDF.

**Требования:**
- Авторизация: Bearer Token
- Роль: ADMIN

**Ответ:** PDF файл с именем `spending_report_YYYY-MM-DD_HH-mm-ss.pdf`

#### GET /api/reports/spending/user/{userId}/pdf
Скачивание отчета о тратах конкретного пользователя в формате PDF.

**Параметры:**
- `userId` - ID пользователя

**Требования:**
- Авторизация: Bearer Token
- Роль: ADMIN или собственный userId

**Ответ:** PDF файл с именем `user_{userId}_spending_report_YYYY-MM-DD_HH-mm-ss.pdf`

## Структура отчета

### Общая информация
- Дата и время формирования отчета
- Общая сумма всех трат (для отчета по всем пользователям)

### По каждому пользователю
- Имя пользователя и ID
- Общая сумма трат пользователя (0 для пользователей без заказов)
- Список всех заказов пользователя (пустой список для пользователей без заказов)

### По каждому заказу
- ID заказа
- Статус заказа
- Общая сумма заказа

## Расчет сумм

### Общая сумма заказа
```
Сумма заказа = Σ(Количество × Цена за единицу для каждого товара в заказе)
```

### Общая сумма трат пользователя
```
Сумма трат пользователя = Σ(Сумма всех заказов пользователя)
```

### Общая сумма всех трат
```
Общая сумма = Σ(Сумма трат всех пользователей)
```

## Примеры использования

### 1. Получение JSON отчета для администратора
```bash
curl -X GET http://localhost:8080/api/reports/spending \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -H "Accept: application/json"
```

### 2. Скачивание PDF отчета
```bash
curl -X GET http://localhost:8080/api/reports/spending/pdf \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -o spending_report.pdf
```

### 3. Получение отчета конкретного пользователя
```bash
curl -X GET http://localhost:8080/api/reports/spending/user/1 \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Accept: application/json"
```

### 4. Скачивание PDF отчета пользователя
```bash
curl -X GET http://localhost:8080/api/reports/spending/user/1/pdf \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -o user_report.pdf
```

## Безопасность

### Контроль доступа
- **Администраторы** имеют доступ ко всем отчетам
- **Обычные пользователи** могут получать только свои отчеты
- Все эндпоинты требуют аутентификации через Bearer Token

### Проверка прав доступа
Система автоматически проверяет:
- Наличие действительного JWT токена
- Соответствие роли пользователя требованиям эндпоинта
- Для пользовательских отчетов - соответствие ID пользователя в токене и запрашиваемом отчете

## Обработка ошибок

### Возможные коды ответов
- **200 OK** - Отчет успешно сформирован
- **403 Forbidden** - Недостаточно прав доступа
- **404 Not Found** - Пользователь не найден
- **500 Internal Server Error** - Ошибка при генерации отчета

### Примеры ошибок
```json
{
  "timestamp": "2024-01-15T10:30:00",
  "status": 403,
  "error": "Forbidden",
  "message": "Access Denied",
  "path": "/api/reports/spending"
}
```

## Технические детали

### Используемые технологии
- **Spring Boot** - основной фреймворк
- **Spring Security** - контроль доступа
- **JPA/Hibernate** - работа с базой данных
- **OpenPDF** - генерация PDF файлов
- **Swagger/OpenAPI** - документация API

### Производительность
- Отчеты генерируются в реальном времени
- Используются оптимизированные запросы с JOIN FETCH для минимизации количества обращений к БД
- PDF файлы генерируются в памяти для быстрой отдачи

### Масштабируемость
- Для больших объемов данных рекомендуется добавить пагинацию
- Возможно кэширование часто запрашиваемых отчетов
- Асинхронная генерация PDF для очень больших отчетов

## Отчет топ-10 товаров

### API Эндпоинты

#### GET /api/reports/top-products
Получение отчета топ-10 самых продаваемых товаров в формате JSON.

**Требования:**
- Авторизация: Bearer Token
- Роль: ADMIN

**Пример ответа:**
```json
{
  "reportDate": "2024-01-15T10:30:00",
  "topProducts": [
    {
      "productId": 1,
      "productName": "Laptop",
      "unitPrice": 999.99,
      "totalQuantitySold": 25,
      "totalRevenue": 24999.75
    },
    {
      "productId": 2,
      "productName": "Mouse",
      "unitPrice": 29.99,
      "totalQuantitySold": 15,
      "totalRevenue": 449.85
    }
  ],
  "totalProductsAnalyzed": 50
}
```

#### GET /api/reports/top-products/pdf
Скачивание отчета топ-10 товаров в формате PDF.

**Требования:**
- Авторизация: Bearer Token
- Роль: ADMIN

**Ответ:** PDF файл с именем `top_products_report_YYYY-MM-DD_HH-mm-ss.pdf`

### Структура отчета топ-10

#### Общая информация
- Дата и время формирования отчета
- Количество товаров, участвовавших в анализе

#### По каждому товару
- ID товара
- Название товара
- Цена за единицу
- Общее количество проданных единиц
- Общая выручка от продаж товара

### Примеры использования

#### Получение JSON отчета топ-10 товаров
```bash
curl -X GET http://localhost:8080/api/reports/top-products \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -H "Accept: application/json"
```

#### Скачивание PDF отчета топ-10 товаров
```bash
curl -X GET http://localhost:8080/api/reports/top-products/pdf \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -o top_products_report.pdf
``` 